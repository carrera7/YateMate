{% extends "base.html" %}

{% block title %}
Ver Amarras
{% endblock %}

{% block content %}
<style>
    /* Estilo para cada tarjeta */
    .card {
        display: block; /* Mostrar todas las tarjetas inicialmente */
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
        border-radius: 5px;
        margin-bottom: 20px;
        padding: 15px;
    }

    /* Estilo para el título de la tarjeta */
    .card-title {
        color: #007bff;
        font-size: 1.5rem;
        margin-bottom: 10px;
    }

    /* Estilo para el botón de la tarjeta */
    .btn-card {
        background-color: #007bff;
        color: #fff;
        padding: 5px 10px;
        text-decoration: none;
        border-radius: 3px;
    }

    /* Estilo para el formulario de filtro */
    .filter-form {
        margin-bottom: 20px;
    }

    .filter-form label {
        margin-right: 10px;
        font-weight: bold;
    }

    .filter-form input[type="date"] {
        padding: 5px;
        border-radius: 3px;
        border: 1px solid #ced4da;
        margin-right: 10px;
    }

    .filter-form button {
        background-color: #007bff;
        color: #fff;
        padding: 5px 10px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        margin-left: 10px;
    }

    .error-message {
        color: red;
        font-size: 0.8rem;
        margin-top: 5px;
    }
    .messages {
    list-style: none;
    padding: 0;
}

.messages li {
    margin: 10px 0;
    padding: 10px;
    border-radius: 5px;
}

.messages li.success {
    background-color: #d4edda;
    color: #155724;
}

.messages li.error {
    background-color: #f8d7da;
    color: #721c24;
}

</style>

{% if objetos %}
    <h2>Publicaciones</h2>

    <!-- Formulario de filtro -->
    <form id="filtroForm" method="GET" action="">
        <div class="filter-form">
            <label for="fecha_inicio">Fecha de inicio:</label>
            <input type="date" id="fecha_inicio" name="fecha_inicio" min="{{ fecha_actual }}" max="{{ ultima_fecha }}" />
            <label for="fecha_fin">Fecha de fin:</label>
            <input type="date" id="fecha_fin" name="fecha_fin" min="{{ fecha_actual }}" max="{{ ultima_fecha }}" />
            <button type="button" onclick="validarFechas()">Filtrar</button>
            <button type="button" onclick="limpiarFiltros()">Limpiar filtros</button>
            <div id="error-msg" class="error-message"></div>
        </div>
    </form>

    <div id="amarras-container">
        {% for amarra in objetos %}
            {% if amarra.estado == 'Vigente' %}
                <div class="card" data-fecha="{{ amarra.fecha_inicio }}">
                    <h3 class="card-title">{{ amarra.ubicacion }} - {{ amarra.precio }}</h3>
                    <p>{{ amarra.fecha_inicio }} - {{ amarra.cant_dias }} días</p>
                    {% if request.session.user_type == 'Usuario' or request.session.user_type == 'Cliente' %}
                        <a href="{% url 'crear_reserva' publicacion_id=amarra.id %}" class="btn-card">Reservar</a>
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}
    </div>

    {% if messages %}
    <ul class="messages">
        {% for message in messages %}
            <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
        {% endfor %}
    </ul>
{% endif %}
    <script>
        function validarFechas() {
            let fechaInicio = document.getElementById("fecha_inicio").value;
            let fechaFin = document.getElementById("fecha_fin").value;
            let errorMsg = document.getElementById("error-msg");
            errorMsg.innerHTML = ""; // Limpiar mensajes de error anteriores

            let fechaActual = new Date().toISOString().slice(0, 10);
            if (fechaInicio === "" || fechaFin === "") {
                errorMsg.innerHTML = "Debe seleccionar ambas fechas.";
                return;
            }

            if (fechaInicio > fechaFin) {
                errorMsg.innerHTML = "La fecha de inicio no puede ser posterior a la fecha de fin.";
                return;
            }

            if (fechaInicio < fechaActual || fechaFin < fechaActual) {
                errorMsg.innerHTML = "No se permiten fechas pasadas.";
                return;
            }

            // Enviar el formulario si las fechas son válidas
            document.getElementById("filtroForm").submit();
        }

        function limpiarFiltros() {
            window.location.href = "{% url 'list_amarra' %}"; // Redirigir a la vista sin filtros
        }
    </script>

{% else %}
    <p>No hay amarras temporales disponibles</p>
{% endif %}

{% endblock %}